---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: falco
spec:
  chart:
    spec:
      chart: falco
      version: 4.x
      sourceRef:
        kind: HelmRepository
        name: falcosecurity
  interval: 1h
  timeout: 15m
  values:
    # Use modern eBPF driver for Talos Linux compatibility
    driver:
      kind: modern_ebpf

    # Falco configuration
    falco:
      grpc:
        enabled: true
      grpcOutput:
        enabled: true
      jsonOutput: true
      jsonIncludeOutputProperty: true
      httpOutput:
        enabled: true
        url: "http://victoria-logs-victoria-logs-single-server:9428/insert/jsonline?_stream_fields=rule,priority&_msg_field=output&_time_field=time"

    # Custom rules can be added later once Falco is running
    # Default rules already cover most security threats

    # Metrics for VictoriaMetrics
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

    # Falcosidekick for forwarding alerts
    falcosidekick:
      enabled: true
      config:
        webhook:
          address: "http://victoria-logs-victoria-logs-single-server:9428/insert/jsonline?_stream_fields=rule,priority&_msg_field=output&_time_field=time"
      webui:
        enabled: true
        replicaCount: 1

    # Resource limits
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 1Gi

    # DaemonSet tolerations to run on all nodes including control plane
    tolerations:
      - effect: NoSchedule
        operator: Exists
      - effect: NoExecute
        operator: Exists

    # Security context
    podSecurityContext:
      runAsNonRoot: false  # Falco needs root for eBPF

    # Talos Linux specific settings
    extra:
      env:
        - name: HOST_ROOT
          value: /host
