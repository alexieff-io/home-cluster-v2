---
apiVersion: operator.lynq.sh/v1
kind: LynqForm
metadata:
  name: lynq-template
  namespace: lynq-system
spec:
  lynqHubRef:
    name: lynq-registry
  template:
    - apiVersion: v1
      kind: Namespace
      metadata:
        name: "node-{{ .uid }}"
        labels:
          lynq.sh/node-id: "{{ .uid }}"
          lynq.sh/managed-by: lynq-operator

    - apiVersion: v1
      kind: ConfigMap
      metadata:
        name: node-config
        namespace: "node-{{ .uid }}"
      data:
        NODE_UID: "{{ .uid }}"
        NODE_URL: "{{ .hostOrUrl }}"
        PLAN_ID: "{{ .planId }}"
        MAX_USERS: "{{ .maxUsers }}"
        STORAGE_GB: "{{ .storageGb }}"

    - apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: node-app
        namespace: "node-{{ .uid }}"
        labels:
          app: node-app
          lynq.sh/node-id: "{{ .uid }}"
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: node-app
        template:
          metadata:
            labels:
              app: node-app
              lynq.sh/node-id: "{{ .uid }}"
          spec:
            containers:
              - name: app
                image: "{{ .deployImage }}"
                ports:
                  - containerPort: 80
                envFrom:
                  - configMapRef:
                      name: node-config
                resources:
                  requests:
                    memory: "64Mi"
                    cpu: "100m"
                  limits:
                    memory: "128Mi"
                    cpu: "200m"

    - apiVersion: v1
      kind: Service
      metadata:
        name: node-service
        namespace: "node-{{ .uid }}"
      spec:
        type: ClusterIP
        selector:
          app: node-app
        ports:
          - port: 80
            targetPort: 80
