---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAgent
metadata:
  name: vmagent
  namespace: monitoring
spec:
  # Replica count
  replicaCount: 1

  # Remote write to VMSingle
  remoteWrite:
    - url: "http://vmsingle-vmsingle:8429/api/v1/write"

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

  # Security context
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    runAsNonRoot: true

  # Service configuration
  serviceSpec:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8429"
    spec:
      type: ClusterIP

  # Service account with cluster-wide read permissions for service discovery
  serviceAccountName: vmagent

  # Select all VMServiceScrapes and VMPodScrapes across all namespaces
  serviceScrapeNamespaceSelector: {}
  podScrapeNamespaceSelector: {}
  serviceScrapeSelector: {}
  podScrapeSelector: {}
  selectAllByDefault: true

  # Additional scrape configs for static targets
  staticScrapeSelector: {}
  staticScrapeNamespaceSelector: {}

  # Node scrape selector
  nodeScrapeSelector: {}
  nodeScrapeNamespaceSelector: {}
