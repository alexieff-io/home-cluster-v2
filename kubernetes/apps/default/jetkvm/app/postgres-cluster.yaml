---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: jetkvm-postgres
  namespace: default
spec:
  instances: 3

  # PostgreSQL image
  imageName: ghcr.io/cloudnative-pg/postgresql:16.3

  # PostgreSQL configuration
  postgresql:
    parameters:
      max_connections: "200"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
      maintenance_work_mem: "64MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "2621kB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"

  # Storage configuration
  storage:
    storageClass: longhorn
    size: 20Gi

  # Bootstrap with initial database and user
  bootstrap:
    initdb:
      database: jetkvm
      owner: jetkvm
      secret:
        name: jetkvm-postgres-superuser

  # Monitoring
  monitoring:
    enablePodMonitor: true

  # Resources
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

  # Affinity rules for high availability
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: preferred

  # Backup configuration (optional - uncomment and configure if needed)
  # backup:
  #   barmanObjectStore:
  #     destinationPath: s3://your-backup-bucket/jetkvm-postgres
  #     endpointURL: https://s3.amazonaws.com
  #     s3Credentials:
  #       accessKeyId:
  #         name: jetkvm-s3-credentials
  #         key: ACCESS_KEY_ID
  #       secretAccessKey:
  #         name: jetkvm-s3-credentials
  #         key: SECRET_ACCESS_KEY
  #     wal:
  #       compression: gzip
  #       maxParallel: 2
  #   retentionPolicy: "30d"

  # Scheduled backup (optional - requires backup configuration above)
  # ---
  # apiVersion: postgresql.cnpg.io/v1
  # kind: ScheduledBackup
  # metadata:
  #   name: jetkvm-postgres-backup
  #   namespace: default
  # spec:
  #   schedule: "0 2 * * *"  # Daily at 2 AM
  #   backupOwnerReference: self
  #   cluster:
  #     name: jetkvm-postgres
